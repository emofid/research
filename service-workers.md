<div dir="rtl">

### سرویس ورکر

سرویس ورکر تکنولوژی جدیدیست. در واقع یک نوع از **web worker** هاست که میتونه روی مرورگر ها نصب بشه و امکانات خوبی در اختیار ما قرار بده.

میشه گفت _Progressive web app_ ها به ما کمک میکنن که امکانات شبیه به یک اپلیکیشن موبایل رو با تکنولوژی وب ارائه بدیم.

یک سرویس ورکر در Thread جداگانه ای اجرا میشود و این موضوع باعث محدودیت هایی میشه که به عنوان مثال میشه گفت که ما مثل جاوااسکریپت دیگر دسترسی به DOM, [LocalStorage](https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/Storage) و XHR نخواهیم داشت.

نکته دیگر این است که یک Service worker حتما باید از طریق وب سایتی با **SSL فعال** نصب گردد. همینطور سرویس ورکر ها در مرورگر **Firefox** در حالت _Private_ فعال نخواهد شد.

یکی از اصلی ترین هدف های PWA اینه که توی موبایل به خوبی اجرا بشه و به ما حس خوبی بده و مشکل اساسی وب این بوده که نمیتوانست قابلیت Offline بودن را هندل کند.

سرویس ورکر میتونه درخواست های شبکه رو رهگیری کنه، اونها رو کش کنه و اگر احساس کنه ارتباط کاربر با اینترنت برقرار نیست محتوای کش شده رو در اختیارش قرار بده.

قابلیت بزرگ بعدی **پوش نوتیفیکیشن** هست که سرویس ورکر در اختیار ما قرار می دهد.

---

### موارد استفاده از سرویس ورکر

- همگام سازی محتوا در پشت صحنه.
- پاسخ دادن به رکوئست ها از دیگر جاها
- دریافت اطلاعاتی که محاسبات سنگینی در بر می گیرد. مثل محاسبه محل جغرافیایی یا اطلاعات Gyroscope کابر، و این امکان که آن را در تمامی صفحات سایت همگام کند.
- کامپایل سمت کاربر چیزهایی مثل CoffeeScript, Less, CJS/AMD ماژول ها و غیره...
- هوک برای سرویس های پشت صحنه
- کمک به افزایش عملکرد، به عنوان مثال گرفتن محتواهایی که کاربر در آینده به آن ها نیاز خواهد داشت، مثل گرفتن چند تصویر بعدی که کاربر در یک آلبوم در حال تماشای آن است.

**امکاناتی که به زودی به سرویس ورکر اضافه خواهد شد و می توان استفاده کرد**:

- همگام سازی به شکل نهان، به این صورت که ما بتوانیم کش های لازم رو حتی در زمانی که کاربر در سایتمان نیست آپدیت کنیم.
- [واکنش نشان دادن به Push messages](https://developer.mozilla.org/en-US/docs/Web/API/Push_API).
- واکنش نسبت به تاریخ و زمان های مشخص.
- واکنش به موقعیت های جغرافیایی کاربر.

---

### چگونه یک سرویس ورکر را نصب کنیم

قبل از هرچیز شما باید بررسی کنید که آیا مرورگر کاربر از سرویس ورکر پشتیبانی می کند یا خیر. برای این منظور از این کد استفاده می کنیم:

<div dir="ltr">

```javascript
if (!("serviceWorker" in navigator)) {
  // service workers not supported 😣
  return;
}
```

</div>

اگر مرورگر از سرویس ورکر پشتیبانی کند میتونید اون رو نصب کنید. برای این منظور هم میتوانید به عنوان مثال یک فایل **worker.js** در روت سایت ایجاد کرده و این کد را در آن قرار دهید:

<div dir="ltr">

```javascript
window.addEventListener("load", () => {
  if (!("serviceWorker" in navigator)) {
    // service workers not supported 😣
    return;
  }

  navigator.serviceWorker.register("/worker.js").then(
    () => {
      // registered! 👍🏼
    },
    err => {
      console.error("SW registration failed! 😱", err);
    }
  );
});
```

</div>

الان ما با متد `navigator.serviceWorker.register()` تونستیم **Service worker** مورد نظر خودمون رو روی مرورگر کاربر نصب کنیم.

---

### چرخه حیات Service worker

من قبلا هم گفته بودم که قبل از اینکه بتونید از سرویس ورکر استفاده کنید لازمه که اون رو روی مرورگر کاربر نصب کنید.
وقتی یک کاربر برای اولین بار وارد سایت شما میشه تنها اتفاقی که میوفته اینه که Service worker شما روی مرورگرش نصب میشه.
ولی تمام امکانات سرویس ورکر شما تا زمانی که کاربر صفحه رو refresh نکنه یا صفحه دیگه ای سایتتون رو نبینه فعال نخواهد شد!
این طراحی سرویس ورکر هست و نمیشه کاریش کرد.

<div style="text-align: center;">

![service worker](https://mdn.mozillademos.org/files/12638/sw101.png)

</div>

بعد از این جریان سرویس ورکر **هر ۲۴ ساعت** دانلود میشه (شایدم بیشتر). ولی حتما باید حداقل هر ۲۴ ساعت دانلود بشه!

ولی عمل نصب بعد از این فقط زمانی اتفاق میافته که سرویس ورکر تغییر کرده باشه.

---

### داخل یک سرویس ورکر چیه؟

داخل یک سرویس ورکر شما میتونید به چند تا `Event` گوش بدید.

`fetch`: زمانی _emit_ میشه که یکی از صفحات وب سایت شما نیاز به چیزی در اینترنت داشته باشد. مثلا بازدید از یک صفحه جدید، یک درخواست _API_، یک تصویر، فایل CSS یا هرچیز دیگه ای...

`install`: زمانی _emit_ میشه که سرویس ورکر شما نصب بشه.

`activate`: این event زمانی _emit_ میشه که سرویس ورکر نصب شده و فعال شده. مثلا در این زمان میتونید هرچیزی که مربوط به نسخه قبلی سرویس ورکرتون هست رو پاک کنید.

`sync`: زمانی _emit_ میشه که مرورگر متوجه بشه پس از یک قطعی اینترنت، دوباره ارتباط برقرار شده و اینترنت در دسترسه.

`push`: این _ایونت_ هم زمانی _امیت_ میشه که یک پوش جدید دریافت شده باشه.

---

### استفاده از محتوای cache شده

وقتی سرویس ورکر نصب شد ما میتونیم ازش بخوایم یه سری از اطلاعات رو **Cache** کنه تا ما بتونیم در زمان استفاده کاربر از حالت Offline ازشون استفاده کنیم.

<div dir="ltr">

```javascript
self.addEventListener("install", event => {
  event.waitUntil(
    caches
      .open("my-site-name")
      .then(cache =>
        cache.addAll([
          "favicon.ico",
          "style.css",
          "script.js",
          "https://fonts.googleapis.com/css?family=Inconsolata:400,700"
        ])
      )
  );
});
```

</div>

این کدها از [Cache Api](https://developer.mozilla.org/en-US/docs/Web/API/Cache) استفاده میکنه تا فایل های مورد نیازمون رو با نام **my-site-name** کش کنه.

خوب حالا بیاید ببینیم چطوری میتونیم به ایونت `fetch` گوش بدیم تا در زمان بعدی که کاربر از سایتمون بازدید میکنه به فایل های کش شده دسترسی داشته باشیم.

<div dir="ltr">

```javascript
self.addEventListener("fetch", event => {
  event.respondWith(
    caches.match(event.request).then(response => {
      if (response) {
        //we found an entry in the cache!
        return response;
      }
      return fetch(event.request);
    })
  );
});
```

</div>

---

### امکان استفاده

در حال حاضر می شود با اطمینان از سرویس ورکر ها استفاده کرد **([سند](https://caniuse.com/#feat=serviceworkers))**

---

## نتیجه تحقیق های من در زمینه Service worker و انجام چند تست

سرویس ورکر برای اینکه بتونیم تب های کاربر رو **sync** کنیم خیلی خوب و مناسبه. کار کردن با API هم خیلی سادست. فقط در مورد کلاس MessageChannel مطالعه کن و به راحتی چیزی که نیاز داری رو پیاده کن.

سرویس ورکر برای اینکه بتونیم دیتا های مورد نیازمون رو کش کنیم هم خیلی خوبه

سرویس ورکر میتونه Push notification هم دریافت کنه. ولی مساله مهمی هم وجود داره، اول اینکه کاربر باید تایید کنه که میخواد Notification دریافت کنه یا نه، بعد از اون هم متاسفانه نمی شه Channel خوب و مشخصی در Push کردن Notification ها مشخص کرد. یعنی Notification ما توسط تمام کاربرانی که Subscribe کردن نمایش داده میشه.

سرویس ورکر میتونه تسک های سنگین یا طولانی ما رو روی یک Thread مجزا اجرا کنه و شاید خیلی به کار ما نیاد. ولی میتونست یک سری از Request های سنگین رو به صورت مجزا اجرا کنه و بعد از گرفتن Response اون رو مستقیما به تمام Tab های فعال push کنه. بعد با Javascript میتونیم Response رو بسته به نیازمون استفاده کنیم. استفاده های خوبی میتونه داشته باشه. ولی الان فکر نمیکنم نیازی برای ما وجود داشته باشه.

**نتیجه اینکه Service worker راه حل مناسب گرفتن Event از سمت سرور، برای ما نیست**!

</div>
